{% extends 'assessments/base.html' %}
{% load currency_filters %}

{% block title %}Unit {{ unit_assessment.unit.unit_number }} - HOA Special Assessment Tracker{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="{% url 'assessments:home' %}">Home</a> /
    <a href="{% url 'assessments:association_detail' unit_assessment.special_assessment.association.id %}">
        {{ unit_assessment.special_assessment.association.name }}
    </a> /
    <a href="{% url 'assessments:assessment_detail' unit_assessment.special_assessment.id %}">
        {{ unit_assessment.special_assessment.name }}
    </a> /
    Unit {{ unit_assessment.unit.unit_number }}
</div>

<div class="card">
    <h2>Unit {{ unit_assessment.unit.unit_number }} - Assessment Details</h2>

    <div class="info-grid">
        <div class="info-item">
            <label>Unit Number</label>
            <div class="value">{{ unit_assessment.unit.unit_number }}</div>
        </div>
        <div class="info-item">
            <label>Owner Name</label>
            <div class="value">{{ unit_assessment.unit.owner_name|default:"N/A" }}</div>
        </div>
        <div class="info-item">
            <label>Payment Option</label>
            <div class="value">{{ unit_assessment.get_payment_option_display }}</div>
        </div>
        <div class="info-item">
            <label>Payment Status</label>
            <div class="value">
                {% with status=unit_assessment.payment_status %}
                <span class="status
                    {% if status == 'Paid in Full' %}status-paid
                    {% elif status == 'Current' %}status-current
                    {% elif status == 'Behind' %}status-behind
                    {% elif status == 'Not Started' %}status-not-started
                    {% elif status == 'Partial Payment' %}status-partial
                    {% else %}status-not-paid
                    {% endif %}">
                    {{ status }}
                </span>
                {% endwith %}
            </div>
        </div>
    </div>

    <div class="actions">
        <a href="{% url 'assessments:monthly_payments' unit_assessment.id %}" class="btn" style="background-color: #28a745; color: white;">Monthly Payments</a>
        <a href="{% url 'assessments:payoff_calculator' unit_assessment.id %}" class="btn" style="background-color: #17a2b8; color: white;">Payoff Calculator</a>
        <a href="{% url 'assessments:edit_payoff' unit_assessment.id %}" class="btn" style="background-color: #fd7e14; color: white;">Edit Payoff</a>
        <a href="{% url 'assessments:adjust_unit_assessment' unit_assessment.id %}" class="btn" style="background-color: #ffc107;">Adjust Amounts</a>
        <a href="{% url 'assessments:download_unit_statement_pdf' unit_assessment.id %}" class="btn">Download PDF Statement</a>
    </div>
</div>

{% if unit_assessment.payoff_amount and unit_assessment.payoff_amount > 0 %}
<div class="card" style="border-left: 4px solid #fd7e14;">
    <h3>Payoff Information</h3>
    <div class="info-grid">
        <div class="info-item">
            <label>Payoff Amount</label>
            <div class="value" style="color: #fd7e14; font-weight: bold;">{{ unit_assessment.payoff_amount|currency }}</div>
        </div>
        <div class="info-item">
            <label>Payoff Date</label>
            <div class="value">{{ unit_assessment.payoff_date|date:"M d, Y"|default:"N/A" }}</div>
        </div>
        <div class="info-item">
            <label>Paid Off Status</label>
            <div class="value">
                {% if unit_assessment.is_paid_off %}
                    <span class="status status-paid">Paid Off</span>
                {% else %}
                    <span class="status status-partial">Partial Payoff</span>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="card">
    <h3>Assessment Breakdown</h3>
    <table>
        <thead>
            <tr>
                <th>Description</th>
                <th>Amount</th>
                <th>Monthly Payment</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Base Assessment</td>
                <td>{{ unit_assessment.base_assessment_amount|currency }}</td>
                <td>{{ unit_assessment.monthly_base_payment|currency }}</td>
            </tr>
            {% for fee in additional_fees %}
            <tr>
                <td>LCE: {{ fee.fee_type }}</td>
                <td>{{ fee.fee_amount|currency }}</td>
                <td>{{ fee.monthly_payment|currency }}</td>
            </tr>
            {% endfor %}
            <tr style="background-color: #366092; color: white; font-weight: bold;">
                <td>TOTAL</td>
                <td>{{ unit_assessment.total_assessment_amount|currency }}</td>
                <td>{{ unit_assessment.total_monthly_payment|currency }}</td>
            </tr>
        </tbody>
    </table>
</div>

<div class="card">
    <h3>Payment Summary</h3>
    <div class="info-grid">
        <div class="info-item">
            <label>Total Assessment</label>
            <div class="value">{{ unit_assessment.total_assessment_amount|currency }}</div>
        </div>
        <div class="info-item">
            <label>Total Paid</label>
            <div class="value" style="color: green;">{{ unit_assessment.total_paid|currency }}</div>
        </div>
        <div class="info-item">
            <label>Remaining Balance / Payoff</label>
            <div class="value" style="color: red;">{{ unit_assessment.remaining_balance|currency }}</div>
        </div>
    </div>
</div>

{% if payments %}
<div class="card">
    <h3>Payment History</h3>
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Amount</th>
                <th>Method</th>
                <th>Reference</th>
                <th>Notes</th>
            </tr>
        </thead>
        <tbody>
            {% for payment in payments %}
            <tr>
                <td>{{ payment.payment_date|date:"M d, Y" }}</td>
                <td>{{ payment.amount|currency }}</td>
                <td>{{ payment.payment_method|default:"N/A" }}</td>
                <td>{{ payment.reference_number|default:"N/A" }}</td>
                <td>{{ payment.notes|default:"" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="card">
    <h3>Payment History</h3>
    <p>No payments recorded yet.</p>
</div>
{% endif %}

{% endblock %}
