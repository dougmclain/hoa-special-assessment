{% extends 'assessments/base.html' %}
{% load currency_filters %}

{% block title %}Payoff Calculator - Unit {{ unit_assessment.unit.unit_number }}{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="{% url 'assessments:home' %}">Home</a> /
    <a href="{% url 'assessments:association_detail' unit_assessment.special_assessment.association.id %}">
        {{ unit_assessment.special_assessment.association.name }}
    </a> /
    <a href="{% url 'assessments:assessment_detail' unit_assessment.special_assessment.id %}">
        {{ unit_assessment.special_assessment.name }}
    </a> /
    <a href="{% url 'assessments:unit_assessment_detail' unit_assessment.id %}">
        Unit {{ unit_assessment.unit.unit_number }}
    </a> /
    Payoff Calculator
</div>

<div class="card">
    <h2>Unit {{ unit_assessment.unit.unit_number }} - Payoff Calculator</h2>
    <p>Calculate the payoff amount required to fully satisfy the special assessment and record payoff payments.</p>

    <div class="actions">
        <a href="{% url 'assessments:unit_assessment_detail' unit_assessment.id %}" class="btn">Back to Unit Details</a>
    </div>
</div>

{% if messages %}
<div class="card">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
</div>
{% endif %}

<div class="card">
    <h3>Current Status</h3>
    <div class="info-grid">
        <div class="info-item">
            <label>Total Assessment</label>
            <div class="value">{{ unit_assessment.total_assessment_amount|currency }}</div>
        </div>
        <div class="info-item">
            <label>Monthly Payment</label>
            <div class="value">{{ unit_assessment.total_monthly_payment|currency }}</div>
        </div>
        <div class="info-item">
            <label>Total Paid (Monthly)</label>
            <div class="value">{{ unit_assessment.payments.all|length }} payments</div>
        </div>
        <div class="info-item">
            <label>Payoff Amount Applied</label>
            <div class="value" style="color: {% if unit_assessment.payoff_amount > 0 %}green{% else %}#666{% endif %};">
                {{ unit_assessment.payoff_amount|currency }}
            </div>
        </div>
    </div>

    {% if unit_assessment.payoff_date %}
    <div style="margin-top: 15px; padding: 10px; background-color: #d4edda; border-left: 4px solid #28a745;">
        <strong>Payoff recorded on {{ unit_assessment.payoff_date|date:"M d, Y" }}</strong>
    </div>
    {% endif %}

    {% if unit_assessment.is_paid_off %}
    <div style="margin-top: 15px; padding: 15px; background-color: #d4edda; border-left: 4px solid #28a745; font-size: 18px;">
        <strong>âœ“ This assessment has been PAID OFF</strong>
    </div>
    {% endif %}
</div>

<div class="card">
    <h3>Current Payoff Amount</h3>
    <div style="font-size: 32px; font-weight: bold; color: #1f4788; margin: 20px 0;">
        {{ current_payoff|currency }}
    </div>
    <p style="color: #666;">As of {{ today|date:"F d, Y" }}</p>
    <p style="margin-top: 10px;">
        This is the amount required to pay off the remaining balance today. This amount includes:
        </p>
    <ul style="margin-left: 20px; color: #666;">
        <li>Remaining principal based on loan amortization</li>
        <li>Interest through today's date</li>
        <li>Minus any payoff amount already applied: {{ unit_assessment.payoff_amount|currency }}</li>
    </ul>
</div>

<div class="card">
    <h3>Calculate Payoff for a Specific Date</h3>
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="calculate">
        <div style="display: flex; gap: 10px; align-items: end; max-width: 500px;">
            <div style="flex: 1;">
                <label for="calculation_date">Payoff Date:</label>
                <input type="date" name="calculation_date" id="calculation_date"
                       value="{{ calculation_date|date:'Y-m-d'|default:today|date:'Y-m-d' }}"
                       style="width: 100%; padding: 8px; font-size: 16px;" required>
            </div>
            <button type="submit" class="btn">Calculate Payoff</button>
        </div>
    </form>

    {% if calculated_payoff %}
    <div style="margin-top: 20px; padding: 15px; background-color: #e7f3ff; border-left: 4px solid #2196F3;">
        <strong>Payoff amount as of {{ calculation_date|date:"F d, Y" }}:</strong>
        <div style="font-size: 24px; font-weight: bold; color: #1f4788; margin-top: 10px;">
            {{ calculated_payoff|currency }}
        </div>
    </div>
    {% endif %}
</div>

<div class="card">
    <h3>Record Payoff Payment</h3>
    <p>Enter the payoff amount and date when a lump sum payment is made. This will reduce the remaining balance.</p>

    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="record_payoff">

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 600px; margin-top: 20px;">
            <div>
                <label for="payoff_amount">Payoff Amount:</label>
                <input type="number" step="0.01" name="payoff_amount" id="payoff_amount"
                       value="{{ unit_assessment.payoff_amount }}"
                       placeholder="0.00"
                       style="width: 100%; padding: 8px; font-size: 16px;" required>
            </div>
            <div>
                <label for="payoff_date">Payment Date:</label>
                <input type="date" name="payoff_date" id="payoff_date"
                       value="{{ unit_assessment.payoff_date|date:'Y-m-d'|default:today|date:'Y-m-d' }}"
                       style="width: 100%; padding: 8px; font-size: 16px;" required>
            </div>
        </div>

        <div style="margin-top: 20px; padding: 15px; background-color: #fff3cd; border-left: 4px solid #ffc107;">
            <strong>Note:</strong> Recording a payoff amount will:
            <ul style="margin: 10px 0 0 20px;">
                <li>Reduce the remaining balance by this amount</li>
                <li>Update the payoff calculation for future dates</li>
                <li>If the remaining balance reaches zero, mark the assessment as paid off</li>
            </ul>
        </div>

        <div style="margin-top: 20px;">
            <button type="submit" class="btn" style="background-color: #28a745; color: white;">
                Record Payoff Payment
            </button>
        </div>
    </form>
</div>

<style>
.alert { padding: 10px; margin: 10px 0; border-radius: 4px; }
.alert-success { background-color: #d4edda; color: #155724; }
.alert-error { background-color: #f8d7da; color: #721c24; }
</style>

{% endblock %}
